# 2022-09-24 - Back dans les bacs

Retour aux affaires apr√®s 1 semaine de s√©minaire en Touraine.

## üå¥ Nouvelle arborescence

√áa devenait le bazar dans les sources.

Afin de pr√©parer la mise en place de tests et pour rendre le code plus modulaire et manipulable : 

- d√©claration et organisation autour d'un package `/src`
- d√©finition des classes `Server` et `Scheduler` afin de faciliter les futurs tests auto et de rendre ces 2 notions centrales explicites et visibles

Gains potentiels :
- plus facile de passer √† du TypeScript
- possibilit√© d'exporter ces classes dans un binaire npm

## üìú Lister les apps

```shell
# Requires `jq` to be installed
$ curl -v localhost:3000/apps -H "PaastisProxyTarget: system" -H "PaastisProxySystemApiToken: abcd-1234-EFGH-5678" | jq .

# Result
[
  {
    "created_at": "2022-09-06T06:28:56.526Z",
    "force_https": false,
    "git_url": "git@ssh.osc-fr1.scalingo.com:hello-fastify.git",
    "id": "xxxxxxxxxxxxxxxxxxxxxxxx",
    "last_deployed_at": "2022-09-07T10:26:41.024Z",
    "name": "hello-fastify",
    "region": "osc-fr1",
    "status": "stopped",
    "updated_at": "2022-09-24T08:37:01.015Z",
    "url": "https://hello-fastify.osc-fr1.scalingo.io",
    "is_monitored": false
  },
  {
    "created_at": "2022-09-06T06:31:59.201Z",
    "force_https": true,
    "git_url": "git@ssh.osc-fr1.scalingo.com:paastis-proxy.git",
    "id": "xxxxxxxxxxxxxxxxxxxxxxxx",
    "last_deployed_at": "2022-09-12T21:59:41.152Z",
    "name": "paastis-proxy",
    "region": "osc-fr1",
    "status": "stopped",
    "updated_at": "2022-09-12T22:00:11.225Z",
    "url": "https://paastis-proxy.osc-fr1.scalingo.io",
    "is_monitored": false
  },
  {
    "created_at": "2022-09-07T13:47:42.781Z",
    "force_https": false,
    "git_url": "git@ssh.osc-fr1.scalingo.com:hellofastifydeux.git",
    "id": "xxxxxxxxxxxxxxxxxxxxxxxx",
    "last_deployed_at": "2022-09-07T13:51:58.667Z",
    "name": "hellofastifydeux",
    "region": "osc-fr1",
    "status": "stopped",
    "updated_at": "2022-09-17T12:22:01.363Z",
    "url": "https://hellofastifydeux.osc-fr1.scalingo.io",
    "is_monitored": false
  }
]
```

## ü¶æ Enhanced apps

Un des probl√®mes actuels est la gestion des groupes d'applications.

Imaginons que j'ai une plateforme constitu√©e d'un front et d'un back (avec lui-m√™me un Redis et un Postgres) :
- r√©veiller le front seul ne suffit pas
- il faut que lorsqu'on acc√®de le front, le back soit lui aussi up

Une solution est de faire √©merger la notion de "Groupe applicatif".
Ce qui donne : 

```shell
group:
- app-front
- app-back
```

Il me faut _un Discovery manager_, g√©r√© via une config.

Lorsque l'on d√©couvre une app, on regarde dans le fichier de config quelles sont les r√®gles associ√©es (ex : idle_time, group, name, description, region, etc.).
Et les ManagedApps seront modifi√©es en cons√©quences.

Un tel syst√®me donne de la flexibilit√© dans la gestion des apps.

## (Apps) Groups management

Il y a 3 endroits dans le code o√π l'on fait `= new RunningApp(` : 
- lorsque l'on d√©marre une App qui n'est pas encore monitor√©e
- lorsque l'on d√©couvre une App au statut `running` lors du CRON
- au moment de r√©cup√©rer une App depuis le registre
