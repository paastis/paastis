# 2022-09-19 - Multi-PaaS, multi-users

## Bilan

Faisons le point, apr√®s 2 semaines tout pile de boulot :
- je n'ai pas de tests auto, ni de CI / CD, ni de package npm, ni image Docker sur le Hub
- j'ai un POC qui valide l'hypoth√®se qu'on peut faire un proxy multi-paas
- le tout est Open Source (licence AGPL-3.0)

## Vision, ambition et licence

> üí° On n'a plus le droit d'utiliser le code [SPDX](https://fr.wikipedia.org/wiki/SPDX) `AGPL-3.0` qui est d√©pr√©ci√©e mais `AGPL-3.0-or-later` ou `AGPL-3.0-only`. 

Je me demande s'il ne faudrait pas changer la licence : **passer de `AGPL-3.0` √† [`CC BY-NC-SA 3.0`](https://creativecommons.org/licenses/by-nc-sa/3.0/deed.fr)**.

**Vision (√† date) :** j'ai envie de conserver un moteur en logiciel libre.
Je suis persuad√© que ce projet peut permettre d'√©conomiser un peu les ressources de la plan√®te et contribuer √† faire de l'IT PaaS-based un endroit √©cologiquement un peu meilleur.
Si plein d'√©quipes utilisent `paastis-engine` ce sera une belle victoire.

A c√¥t√© de √ßa, je trouve l√©gitime de pouvoir retirer de tout mon travail une r√©mun√©ration pour toutes ces heures pass√©es et toutes les comp√©tences mobilis√©es (lesquelles sont le r√©sultat d'ann√©es d'efforts et progression).

**Proposition de valeur :** tout repose sur 3 promesses fortes qui n'ont pas chang√© depuis le premier jour :
- √©conomique
- √©cologique
- pratique

**Business model :** Je vois 3 axes pour la partie payante : 
- proposer l'h√©bergement d'une (multitude d') instance(s) (?) pour simplifier encore plus la vie des √©quipes
- proposer une console d'admin Web (+ mobile apps) qui renforce la promesse "pratique"
- proposer du support et une priorit√© aux √©quipes qui payent 

**Business plans :** (√† tester / am√©liorer)
- free : 1 provider, 5 apps max en m√™me temps
- team : 3 providers, 15 apps max en m√™me temps pour chaque provider
- enterprise : 5 providers, 100 apps max en m√™me temps pour chaque provider

> ‚ùìComment faire en sorte que le code de l'engine soit open source tout en prot√©geant mon activit√© ? 

## Architecture SaaS

J'en viens √† me questionner sur la partie SaaS.

O√π et comment g√©rer le fait d'avoir plusieurs clients ?

Si on commence √† g√©rer les _Espaces_ (1 espace = 1 config de provider pour 1 user) dans paastis-engine, √ßa va rendre le projet inutilisable pour les √©ventuels d√©veloppeurs ou √©quipes initialement int√©ress√©es.

### MicroVMs & Firecracker

J'ai entendu parler (par Yves d'Empreinte Digitale) de [Firecracker](https://firecracker-microvm.github.io/), une techno OSS d'orchestration de _microVMs_.

> Firecracker is an open source virtualization technology that is purpose-built for creating and managing secure, multi-tenant container and function-based services. 

Une piste peut √™tre de g√©n√©rer et g√©rer plein de microVMs, 1 par Espace.

Avantages :
- s√©gr√©gation forte (_a priori_) des flux et donn√©es
- 

Risques :
- le co√ªt d'infra
- les comp√©tences d'admin syst√®me sp√©cialis√© en VM (que je pense ne pas avoir aujourd'hui)
- le code de glue √† inventer (vs. du CRUD en Node.js)

### TODO-list & feedbacks

J'ai eu une belle et longue discussion de conception / feedback avec J**.
J'en retire un max d'id√©es et de choses, dont des demandes d'√©volutions ou des bugs.
Il a accept√© de d√©ployer sur un vrai projet avec une demi-douzaine de review apps.

- [ ] Il faut que je blinde la doc (m√™me s'il lui a suffi de lire le code)
    - je songeais d√©j√† √† mettre en place prochainement Docusaurus
    - il faut penser √† la partie DNS, notamment c√¥t√© PaaS
- [X] Le `README.md` contient (d√©j√†) des infos erron√©es ou manquantes (du coup, il ne les contient pas)
    - il manque des variables d'environnement dont la partie Redis
- [X] Le client JS Scalingo ne tient pas compte du refresh token et donc au bout d'1 heure, l'application crashe
- [ ] L'application crashe trop souvent
    - quand le Redis n'est pas pr√™t
    - quand le token Scalingo a expir√©
- [X] Il y a un `console.log` bien sale au startup avec les secrets ü§¶‚Äç‚ôÇÔ∏è
- [ ] Il faudrait avoir une white list des applis √† prendre en compte plut√¥t qu'un blacklist
    - [ ] il faudrait que ces listes acceptent les patterns
- [ ] Il faudrait avoir la liste des apps manag√©es au startup
- [ ] Il faudrait proposer une CLI packag√©e dans npm pour simplifier l'exploitation en-dehors d'un h√©bergeur

Au-del√† de toutes ces remarques (tr√®s justes) on a √©voqu√© le fait que ce qui l'int√©resserait plus, serait d'avoir un contr√¥le non pas au niveau du provider+zone (= "R√©gion"), mais au niveau de chaque application.

Comme Tr√¶fik, il faudrait pouvoir dissocier la d√©couvrabilit√© des apps du reste.
Chaque appli ayant √©t√© un jour manag√©e pourrait √™tre stock√©e en BDD.
Je sens que c'est une excellente direction √† prendre, mais que √ßa repr√©sente un boulot monstrueux !

Autre point : le fait de permettre d'avoir un Registre in-memory ne permet pas d'exploiter tout le potentiel de Redis.
Et notamment, oblige √† avoir une API syst√®me g√©rer par l'engine.
On pourrait imaginer que l'API syst√®me soit plus d√©coupl√©e et g√©r√©e √† c√¥t√©. 

Il a √©t√© question aussi de proposer d'avoir / d√©clarer /rendre des apps multi-tenants.
L'id√©e est tr√®s int√©ressante.
Mais je pense qu'elle n'entre pas dans le cadre de ce projet.
En tout cas, pas pour le moment.
Peut-√™tre si un jour je dois pivoter.
